name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "{{ cookiecutter.python_version }}"

      - name: Install dependencies
        run: |
          pip install -U pip
          pip install -e .
          pip install pytest sphinx

      # -------------------------
      # STRUCTURE ENFORCEMENT
      # -------------------------

      - name: Verify required directories
        run: |
          test -d docs
          test -d tests
          test -d src

      - name: Verify planning docs exist
        run: |
          test -f docs/vision.rst
          test -f docs/architecture.rst
          test -f docs/implementation_plan.rst
          test -f docs/implementation_status.rst

      - name: Verify test plan exists
        run: |
          test -f tests/test_plan.md

      # -------------------------
      # ADR ENFORCEMENT
      # -------------------------

      - name: Ensure ADRs exist if architecture changed
        run: |
          if git diff --name-only origin/main...HEAD | grep -q docs/architecture.rst; then
            test -d docs/decisions || (echo "Missing docs/decisions" && exit 1)
            ls docs/decisions/ADR-*.rst >/dev/null 2>&1 || \
              (echo "Architecture changed but no ADR added" && exit 1)
          fi

      # -------------------------
      # TESTS
      # -------------------------

      - name: Run tests
        run: pytest

      # -------------------------
      # DOCS
      # -------------------------

      - name: Build Sphinx docs
        run: |
          sphinx-build -W docs docs/_build
